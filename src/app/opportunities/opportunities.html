<div class="opportunities-container">
  <div class="header">
    <div class="header-content">
      <button mat-icon-button routerLink="/" class="back-button">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <div class="header-text">
        <h1>Arbitrage Opportunities</h1>
        @if (isLoading()) {
          <p>Loading opportunities...</p>
        } @else if (error()) {
          <p class="error-text">{{ error() }}</p>
        } @else {
          <p>{{ totalItems() }} opportunities found</p>
        }
      </div>
      <button mat-raised-button color="primary" (click)="loadData()" [disabled]="isLoading()">
        <mat-icon>refresh</mat-icon>
        Refresh
      </button>
    </div>
  </div>

  @if (isLoading()) {
    <div class="loading-container">
      <mat-spinner></mat-spinner>
      <p>Fetching latest prices...</p>
    </div>
  } @else if (error()) {
    <mat-card class="error-card">
      <mat-icon color="warn">error</mat-icon>
      <p>{{ error() }}</p>
      <button mat-raised-button color="primary" (click)="loadData()">Try Again</button>
    </mat-card>
  } @else {
    <mat-card class="filters-card">
      <div class="filters-header">
        <h3>
          <mat-icon>filter_list</mat-icon>
          Advanced Filters
          @if (activeFiltersCount() > 0) {
            <mat-chip class="filter-count-chip">{{ activeFiltersCount() }} active</mat-chip>
          }
        </h3>
        <button mat-stroked-button (click)="clearFilters()" class="clear-all-button" [disabled]="activeFiltersCount() === 0">
          <mat-icon>clear_all</mat-icon>
          Clear All Filters
        </button>
      </div>

      <div class="filters-container">
        <!-- Search -->
        <mat-form-field appearance="outline" class="search-field">
          <mat-label>Search Items</mat-label>
          <input
            matInput
            placeholder="Search by item name..."
            [value]="searchTerm()"
            (input)="onSearchChange($event)"
          />
          <mat-icon matPrefix>search</mat-icon>
        </mat-form-field>

        <!-- Category -->
        <mat-form-field appearance="outline">
          <mat-label>Category</mat-label>
          <mat-select [value]="selectedCategory()" (selectionChange)="onCategoryChange($event.value)">
            @for (category of availableCategories(); track category) {
              <mat-option [value]="category">{{ category === 'all' ? 'All Categories' : category }}</mat-option>
            }
          </mat-select>
        </mat-form-field>

        <!-- Wear -->
        <mat-form-field appearance="outline">
          <mat-label>Wear Condition</mat-label>
          <mat-select [value]="selectedWear()" (selectionChange)="onWearChange($event.value)">
            @for (wear of availableWears(); track wear) {
              <mat-option [value]="wear">{{ wear === 'all' ? 'All Wears' : wear }}</mat-option>
            }
          </mat-select>
        </mat-form-field>

        <!-- Cheaper Platform -->
        <mat-form-field appearance="outline">
          <mat-label>Cheaper On</mat-label>
          <mat-select [value]="selectedPlatform()" (selectionChange)="onPlatformChange($event.value)">
            @for (platform of platforms; track platform) {
              <mat-option [value]="platform">{{ platform === 'all' ? 'All Platforms' : platform }}</mat-option>
            }
          </mat-select>
        </mat-form-field>

        <!-- Best Direction -->
        <mat-form-field appearance="outline">
          <mat-label>Best Route</mat-label>
          <mat-select [value]="selectedDirection()" (selectionChange)="onDirectionChange($event.value)">
            @for (direction of directions; track direction) {
              <mat-option [value]="direction">{{ direction === 'all' ? 'All Directions' : direction }}</mat-option>
            }
          </mat-select>
        </mat-form-field>

        <!-- Price Range -->
        <mat-form-field appearance="outline" class="number-field">
          <mat-label>Min Price $</mat-label>
          <input
            matInput
            type="number"
            min="0"
            step="0.1"
            placeholder="Any"
            [value]="minPrice() ?? ''"
            (input)="onMinPriceChange($event)"
          />
          <mat-icon matPrefix>attach_money</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline" class="number-field">
          <mat-label>Max Price $</mat-label>
          <input
            matInput
            type="number"
            min="0"
            step="0.1"
            placeholder="Any"
            [value]="maxPrice() ?? ''"
            (input)="onMaxPriceChange($event)"
          />
          <mat-icon matPrefix>attach_money</mat-icon>
        </mat-form-field>

        <!-- Profit Range -->
        <mat-form-field appearance="outline" class="number-field">
          <mat-label>Min Profit $</mat-label>
          <input
            matInput
            type="number"
            step="0.1"
            placeholder="Any"
            [value]="minProfit() ?? ''"
            (input)="onMinProfitChange($event)"
          />
          <mat-icon matPrefix>attach_money</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline" class="number-field">
          <mat-label>Max Profit $</mat-label>
          <input
            matInput
            type="number"
            step="0.1"
            placeholder="Any"
            [value]="maxProfit() ?? ''"
            (input)="onMaxProfitChange($event)"
          />
          <mat-icon matPrefix>attach_money</mat-icon>
        </mat-form-field>

        <!-- ROI Range -->
        <mat-form-field appearance="outline" class="number-field">
          <mat-label>Min ROI %</mat-label>
          <input
            matInput
            type="number"
            step="1"
            placeholder="Any"
            [value]="minROI() ?? ''"
            (input)="onMinROIChange($event)"
          />
          <mat-icon matPrefix>percent</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline" class="number-field">
          <mat-label>Max ROI %</mat-label>
          <input
            matInput
            type="number"
            step="1"
            placeholder="Any"
            [value]="maxROI() ?? ''"
            (input)="onMaxROIChange($event)"
          />
          <mat-icon matPrefix>percent</mat-icon>
        </mat-form-field>

        <!-- Profitable Only -->
        <div class="checkbox-filter">
          <mat-checkbox
            [checked]="profitableOnly()"
            (change)="onProfitableOnlyChange($event.checked)"
            color="primary"
          >
            Show Profitable Only
          </mat-checkbox>
        </div>
      </div>
    </mat-card>

    <mat-card class="table-card">
      <div class="table-container">
        <table
          mat-table
          [dataSource]="paginatedOpportunities()"
          matSort
          (matSortChange)="onSortChange($event)"
          [matSortActive]="sortColumn()"
          [matSortDirection]="sortDirection()"
          class="opportunities-table"
        >
          <!-- Item Name Column -->
          <ng-container matColumnDef="itemName">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Item Name</th>
            <td mat-cell *matCellDef="let item">
              <div class="item-name">
                {{ item.itemName }}
              </div>
            </td>
          </ng-container>

          <!-- CSFloat Price Column -->
          <ng-container matColumnDef="csfloatPrice">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>CSFloat Price</th>
            <td mat-cell *matCellDef="let item" class="price-cell">
              {{ formatCurrency(item.csfloatPrice) }}
            </td>
          </ng-container>

          <!-- BUFF163 Price Column -->
          <ng-container matColumnDef="buff163Price">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>BUFF163 Price</th>
            <td mat-cell *matCellDef="let item" class="price-cell">
              {{ formatCurrency(item.buff163Price) }}
            </td>
          </ng-container>

          <!-- Raw Price Diff Column -->
          <ng-container matColumnDef="rawPriceDiff">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Price Diff</th>
            <td mat-cell *matCellDef="let item" class="diff-cell" [class.positive]="item.rawPriceDiff && item.rawPriceDiff > 0" [class.negative]="item.rawPriceDiff && item.rawPriceDiff < 0">
              {{ formatCurrency(item.rawPriceDiff) }}
            </td>
          </ng-container>

          <!-- % Difference Column -->
          <ng-container matColumnDef="percentDifference">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>% Diff</th>
            <td mat-cell *matCellDef="let item" [class.positive]="item.percentDifference && item.percentDifference > 0" [class.negative]="item.percentDifference && item.percentDifference < 0">
              {{ formatPercent(item.percentDifference) }}
            </td>
          </ng-container>

          <!-- Cheaper Platform Column -->
          <ng-container matColumnDef="cheaperPlatform">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Cheaper On</th>
            <td mat-cell *matCellDef="let item">
              <mat-chip [class.csfloat-chip]="item.cheaperPlatform === 'CSFloat'" [class.buff-chip]="item.cheaperPlatform === 'Buff163'">
                {{ item.cheaperPlatform }}
              </mat-chip>
            </td>
          </ng-container>

          <!-- Best Direction Column -->
          <ng-container matColumnDef="bestDirection">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Best Route</th>
            <td mat-cell *matCellDef="let item">
              <mat-chip [style.background-color]="getDirectionColor(item.bestDirection)">
                {{ item.bestDirection }}
              </mat-chip>
            </td>
          </ng-container>

          <!-- Best Profit Column -->
          <ng-container matColumnDef="bestProfit">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Best Profit</th>
            <td mat-cell *matCellDef="let item" class="profit-cell" [class.profitable]="item.profitable">
              {{ formatCurrency(item.bestProfit) }}
            </td>
          </ng-container>

          <!-- Best ROI Column -->
          <ng-container matColumnDef="bestROI">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Best ROI %</th>
            <td mat-cell *matCellDef="let item">
              <div class="roi-badge" [class.profitable]="item.bestROI && item.bestROI > 0">
                {{ formatPercent(item.bestROI) }}
              </div>
            </td>
          </ng-container>

          <!-- B→C ROI Column -->
          <ng-container matColumnDef="bc_roi">
            <th mat-header-cell *matHeaderCellDef mat-sort-header matTooltip="Buff → CSFloat ROI">B→C ROI %</th>
            <td mat-cell *matCellDef="let item">
              {{ formatPercent(item.bc_roi) }}
            </td>
          </ng-container>

          <!-- C→B ROI Column -->
          <ng-container matColumnDef="cb_roi">
            <th mat-header-cell *matHeaderCellDef mat-sort-header matTooltip="CSFloat → Buff ROI">C→B ROI %</th>
            <td mat-cell *matCellDef="let item">
              {{ formatPercent(item.cb_roi) }}
            </td>
          </ng-container>

          <!-- Profitable Column -->
          <ng-container matColumnDef="profitable">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Profitable?</th>
            <td mat-cell *matCellDef="let item">
              <mat-icon [class.profitable-icon]="item.profitable" [class.unprofitable-icon]="!item.profitable">
                {{ item.profitable ? 'check_circle' : 'cancel' }}
              </mat-icon>
            </td>
          </ng-container>

          <!-- Category Column -->
          <ng-container matColumnDef="category">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Category</th>
            <td mat-cell *matCellDef="let item">
              {{ item.category }}
            </td>
          </ng-container>

          <!-- Wear Column -->
          <ng-container matColumnDef="wear">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Wear</th>
            <td mat-cell *matCellDef="let item">
              {{ item.wear }}
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns" class="table-row"></tr>
        </table>
      </div>

      <mat-paginator
        [length]="totalItems()"
        [pageSize]="pageSize()"
        [pageIndex]="pageIndex()"
        [pageSizeOptions]="[10, 25, 50, 100, 250]"
        (page)="onPageChange($event)"
        showFirstLastButtons
      >
      </mat-paginator>
    </mat-card>
  }
</div>
